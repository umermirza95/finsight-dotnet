@page "/login"


@using Finsight.Commands
@using Finsight.Interfaces
@using System.Security.Claims
@using System.Security.Cryptography.X509Certificates
@using Finsight.Models
@using Microsoft.AspNetCore.Authentication
@inject NavigationManager Nav
@inject IFSUserService FSUserService;
@inject JwtAuthenticationStateProvider JwtAuthStateProvider;

<div class="min-h-screen bg-primary md:bg-white flex items-center justify-center p-4">

    <div class="flex w-full max-w-4xl bg-white rounded-[40px] shadow-2xl overflow-hidden">

        <div class="hidden md:flex w-2/5 bg-primary p-10 flex-col justify-center items-center text-left">

            <div class="mb-8 w-full">
                <svg class="h-10 w-10 text-primary-text" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="24" height="24" rx="12" fill="currentColor" />
                    <path d="M7 17L17 7M7 7H17V17" stroke="#ffffff" stroke-width="2" />
                </svg>
            </div>

            <h1 class="text-5xl font-extrabold text-primary-text leading-tight w-full">
                Welcome<br>back!
            </h1>
        </div>

        <div class="w-full md:w-3/5 p-10 lg:p-16 flex flex-col justify-center">

            <h2 class="text-4xl font-bold mb-10 text-gray-800">Log In</h2>

            <EditForm Model="@loginModel" OnValidSubmit="@HandleLogin">
                <DataAnnotationsValidator />

                <div class="mb-6">
                    <InputText id="Email" @bind-Value="loginModel.Email" placeholder="Email Address"
                        class="w-full px-5 py-4 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-gray-800 text-gray-700" />
                    <ValidationMessage For="@(() => loginModel.Email)" class="text-red-500 text-sm mt-1 block" />
                </div>

                <div class="mb-4">
                    <input type="password" id="Password" @bind-value="loginModel.Password" placeholder="Password"
                        class="w-full px-5 py-4 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-gray-800 text-gray-700" />
                    <ValidationMessage For="@(() => loginModel.Password)" class="text-red-500 text-sm mt-1 block" />
                </div>

                <div class="flex justify-end mb-8">
                    <a href="#" class="text-sm text-gray-500 hover:text-gray-700 font-medium">
                        Forgot Password?
                    </a>
                </div>

                <button type="submit"
                    class="w-full py-4 bg-gray-900 text-white font-bold rounded-full hover:bg-gray-700 transition duration-200 shadow-md">
                    Login
                </button>
            </EditForm>

            @* --- ERROR MESSAGE DISPLAY --- *@
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="mt-4 p-3  text-red-500 rounded-lg text-center font-medium" role="alert">
                    @errorMessage
                </div>
            }
            @* ----------------------------- *@

            <div class="mt-8 text-center text-sm">
                <span class="text-gray-500">Don't have an account?</span>
                <a href="#" class="text-gray-900 font-bold hover:text-gray-700 ml-1">
                    Sign up

                </a>
            </div>

        </div>
    </div>
</div>

@code {

    private LoginFSUserCommand loginModel = new LoginFSUserCommand();
    private string errorMessage = string.Empty;

    // 3. Handle the form submission
    async private void HandleLogin()
    {
        errorMessage = "";
        try
        {
            var user = await FSUserService.Login(loginModel);
            string token = FSUserService.GenerateToken(user);
            await JwtAuthStateProvider.MarkUserAsAuthenticated(token);
            Nav.NavigateTo("/dashboard", forceLoad: true);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            StateHasChanged();
        }
    }


}