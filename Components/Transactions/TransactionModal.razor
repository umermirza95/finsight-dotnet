@using Finsight.Commands
@using Finsight.Enums
@using Finsight.Interfaces
@using Finsight.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity

@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<FSUser> UserManager
@inject ICategoryService CategoryService
@inject ITransactionService TransactionService

<div class="fixed inset-0 z-50 bg-black/50 flex justify-center items-center"
     style="@(IsVisible ? "" : "display:none")"
     @onclick="HandleBackgroundClick">

    <div class="bg-white rounded-3xl shadow-2xl w-full md:max-w-md p-6"
         @onclick:stopPropagation="true">

        <h3 class="text-2xl font-semibold text-center mb-4">
            Record Transaction
        </h3>

        <EditForm Model="@TransactionData" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-red-600 mb-4" />

            <!-- Transaction Type -->
            <div class="mb-4">
                <label class="block mb-1">Transaction Type</label>
                <InputSelect @bind-Value="TransactionData.Type"
                             class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2">
                    <option value="@FSTransactionType.income">Income</option>
                    <option value="@FSTransactionType.expense">Expense</option>
                </InputSelect>
                <ValidationMessage For="@(() => TransactionData.Type)" />
            </div>

            <!-- Amount / Currency -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block mb-1">Amount</label>
                    <InputNumber @bind-Value="TransactionData.Amount"
                                 class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2" />
                    <ValidationMessage For="@(() => TransactionData.Amount)" />
                </div>

                <div>
                    <label class="block mb-1">Currency</label>
                    <InputSelect @bind-Value="TransactionData.Currency"
                                 class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => TransactionData.Currency)" />
                </div>
            </div>

            <!-- Category / SubCategory -->
            <div class="grid gap-4 mb-4 @(SubCategories.Any() ? "grid-cols-2" : "grid-cols-1")">
                <div>
                    <label class="block mb-1">Category</label>
                    <select class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2"
                            @onchange="OnCategoryChanged">
                        <option value="">Select</option>
                        @foreach (var cat in Categories)
                        {
                            <option value="@cat.Id">@cat.Name</option>
                        }
                    </select>

                    @if (!string.IsNullOrEmpty(CategoryValidationError))
                    {
                        <div class="text-red-600 text-sm mt-1">
                            @CategoryValidationError
                        </div>
                    }
                </div>

                @if (SubCategories.Any())
                {
                    <div>
                        <label class="block mb-1">Sub Category</label>
                        <select class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2"
                                @bind="TransactionData.SubCategoryId">
                            <option value="">Select</option>
                            @foreach (var sub in SubCategories)
                            {
                                <option value="@sub.Id">@sub.Name</option>
                            }
                        </select>
                    </div>
                }
            </div>

            <!-- Comment -->
            <div class="mb-4">
                <label class="block mb-1">Comment</label>
                <InputTextArea @bind-Value="TransactionData.Comment"
                               class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2" />
                <ValidationMessage For="@(() => TransactionData.Comment)" />
            </div>

            <!-- Mode / Date -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block mb-1">Mode</label>
                    <InputSelect @bind-Value="TransactionData.Mode"
                                 class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2">
                        <option value="@FSTransactionMode.cash">Cash</option>
                        <option value="@FSTransactionMode.card">Card</option>
                        <option value="@FSTransactionMode.transfer">Transfer</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => TransactionData.Mode)" />
                </div>

                <div>
                    <label class="block mb-1">Date</label>
                    <InputDate @bind-Value="DateProxy"
                               class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2" />
                </div>
            </div>

            <button type="submit"
                    class="w-full py-3 bg-gray-900 text-white rounded-3xl">
                Add
            </button>
        </EditForm>
    </div>
</div>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }

    private CreateTransactionCommand TransactionData = new();

    private List<FSCategory> Categories = [];
    private List<FSSubCategory> SubCategories = [];

    private Guid? SelectedCategoryId;
    private Guid? SelectedSubCategoryId;
    private string? CategoryValidationError;

    private DateTime? DateProxy
    {
        get => TransactionData.Date?.ToDateTime(TimeOnly.MinValue);
        set => TransactionData.Date = value.HasValue
            ? DateOnly.FromDateTime(value.Value)
            : null;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);

        if (user != null)
        {
            TransactionData.Currency = user.DefaultCurrency ?? "USD";
            Categories = await CategoryService.GetCategoriesAsync(user.Id);
        }
    }

    private void OnCategoryChanged(ChangeEventArgs e)
    {
        CategoryValidationError = null;

        if (!Guid.TryParse(e.Value?.ToString(), out var categoryId))
        {
            SelectedCategoryId = null;
            SubCategories.Clear();
            return;
        }

        SelectedCategoryId = categoryId;
        TransactionData.CategoryId = categoryId;

        var category = Categories.FirstOrDefault(c => c.Id == categoryId);

        SubCategories = category?.SubCategories?.Any() == true
            ? category.SubCategories.ToList()
            : [];

        SelectedSubCategoryId = null;
        TransactionData.SubCategoryId = null;
    }

    private async Task HandleValidSubmit()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);

        if (user == null)
            return;


        TransactionData.SubCategoryId = SelectedSubCategoryId;

        await TransactionService.AddTransactionWithFXAsync(TransactionData, user.Id);

        await IsVisibleChanged.InvokeAsync(false);

        TransactionData = new();
        SelectedCategoryId = null;
        SelectedSubCategoryId = null;
        SubCategories.Clear();
    }

    private async Task HandleBackgroundClick()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }
}