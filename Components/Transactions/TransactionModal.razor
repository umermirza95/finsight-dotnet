@using Finsight.Interfaces
@using Finsight.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity

@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<FSUser> UserManager
@inject ICategoryService CategoryService

<div class="fixed inset-0 z-50 bg-black/50 flex justify-center items-center" style="@(IsVisible ? "" : "display:none")"
    @onclick="HandleBackgroundClick">

    <div class="bg-white rounded-3xl shadow-2xl w-full md:max-w-md p-6" @onclick:stopPropagation="true">

        <h3 class="text-2xl font-semibold text-center mb-4">
            Record Transaction
        </h3>

        <EditForm Model="@TransactionData" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />

            <!-- Transaction Type -->
            <div class="mb-4">
                <label class="text-md  mb-1 block">Transaction Type</label>
                <InputSelect @bind-Value="TransactionData.TransactionType"
                    class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2">
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </InputSelect>
            </div>

            <!-- Amount / Currency -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-md  mb-1 block">Amount</label>
                    <InputNumber @bind-Value="TransactionData.Amount"
                        class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2" />
                </div>

                <div>
                    <label class="text-md  mb-1 block">Currency</label>
                    <InputSelect @bind-Value="TransactionData.Currency"
                        class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                    </InputSelect>
                </div>
            </div>

            <!-- Category / SubCategory -->
            <div class="grid gap-4 mb-4 @(SubCategories.Any() ? "grid-cols-2" : "grid-cols-1")">
                <div>
                    <label class="text-md mb-1 block">Category</label>
                    <select class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2"
                        @onchange="OnCategoryChanged">
                        <option value="">Select</option>
                        @foreach (var cat in Categories)
                        {
                            <option value="@cat.Id">@cat.Name</option>
                        }
                    </select>
                </div>

                @if (SubCategories.Any())
                {
                    <div>
                        <label class="text-md mb-1 block">Sub Category</label>
                        <select class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2"
                            @bind="SelectedSubCategoryId">
                            <option class="text-gray-50" value="">Select</option>
                            @foreach (var sub in SubCategories)
                            {
                                <option value="@sub.Id">@sub.Name</option>
                            }
                        </select>
                    </div>
                }
            </div>

            <!-- Comments -->
            <div class="mb-4">
                <label class="text-md mb-1 block">Comments</label>
                <InputTextArea @bind-Value="TransactionData.Comments"
                    class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2" />
            </div>

            <!-- Mode / Date -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-md mb-1 block">Mode</label>
                    <InputSelect @bind-Value="TransactionData.Mode"
                        class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2">
                        <option value="Cash">Cash</option>
                        <option value="Card">Card</option>
                        <option value="Transfer">Transfer</option>
                    </InputSelect>
                </div>

                <div>
                    <label class="text-md mb-1 block">Date</label>
                    <InputDate @bind-Value="TransactionData.Date"
                        class="w-full h-12 rounded-lg bg-gray-50 border border-primary px-2" />
                </div>
            </div>

            <button type="submit" class="w-full py-3 bg-gray-900 text-white rounded-3xl">
                Add
            </button>
        </EditForm>
    </div>
</div>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public EventCallback<Transaction> OnTransactionAdded { get; set; }

    private Transaction TransactionData = new();

    private List<FSCategory> Categories = [];
    private List<FSSubCategory> SubCategories = [];

    private Guid? SelectedCategoryId;
    private Guid? SelectedSubCategoryId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);

        if (user != null)
        {
            TransactionData.Currency = user.DefaultCurrency ?? "USD";
            Categories = await CategoryService.GetCategoriesAsync(user.Id);
        }
    }

    private void OnCategoryChanged(ChangeEventArgs e)
    {
        if (!Guid.TryParse(e.Value?.ToString(), out var categoryId))
        {
            SelectedCategoryId = null;
            SubCategories.Clear();
            return;
        }

        SelectedCategoryId = categoryId; // â† MISSING LINE (critical)

        var category = Categories.FirstOrDefault(c => c.Id == categoryId);

        SubCategories = category?.SubCategories?.Any() == true
        ? category.SubCategories.ToList()
        : [];

        SelectedSubCategoryId = null;
    }

    private async Task HandleValidSubmit()
    {
        TransactionData.CategoryId = SelectedCategoryId ?? Guid.Empty;

        await OnTransactionAdded.InvokeAsync(TransactionData);
        await IsVisibleChanged.InvokeAsync(false);

        TransactionData = new();
        SelectedCategoryId = null;
        SelectedSubCategoryId = null;
        SubCategories.Clear();
    }

    private async Task HandleBackgroundClick()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }
}